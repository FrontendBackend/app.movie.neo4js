<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Conexión a Neo4j</title>
    <script src="https://cdn.jsdelivr.net/npm/neo4j-driver"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-top: 20px;
            /* Ajusta el margen según sea necesario */
        }

        #cyUser {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            /* transition: width 0.5s, height 0.5s; */

            transition: all 0.5s ease;
            /* Animación de transición */
        }

        #cyPeli {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            /* transition: width 0.5s, height 0.5s; */

            transition: all 0.5s ease;
            /* Animación de transición */
        }

        .tabla {
            width: 100%;
            height: 700px;
            overflow-y: auto;
        }

        .toast-custom {
            bottom: -580px !important;
            /* Ajusta el valor para colocar el toast donde desees */
            top: auto !important;
            transform: translateX(-50%) !important;
        }

        #cyUser.fullscreenU {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            /* Asegurar que el elemento esté encima de todo */
        }

        #cyPeli.fullscreenP {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            /* Asegurar que el elemento esté encima de todo */
        }

        #button-container-peli {
            position: absolute;
            top: 50px;
            right: 10px;
            z-index: 10000;
            /* Asegurar que el botón esté encima de todo */
        }

        #button-container-user {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10000;
            /* Asegurar que el botón esté encima de todo */
        }
    </style>
</head>

<body>

    <div class="row">
        <div class="row">
            <div class="card">
                <div class="input-field col s1.5 m1.5">
                    <select id="user-select" selected>
                        <option value="">Selecionar usuario</option>
                    </select>
                </div>
                <div class="input-field col s1.5 m1.5">
                    <button id="searchButton-user" class="btn waves-effect waves-light blue" type="submit">
                        <i class="material-icons right">search</i> Buscar
                    </button>
                </div>

                <div class="input-field col s1.5 m1.5">
                    <select id="genero-select">
                        <option value="">Selecionar género</option>
                    </select>
                </div>
                <div class="input-field col s1.5 m1.5">
                    <button id="searchButton-genero" class="btn waves-effect waves-light blue" type="submit">
                        <i class="material-icons right">search</i> Buscar
                    </button>
                </div>

                <div class="input-field col s1.5 m1.5">
                    <input type="text" id="textInputBusqueda">
                    <label for="textInputBusqueda">Texto de búsqueda</label>
                </div>
                <div class="input-field col s1.5 m1.5">
                    <button id="searchButton-textBusqueda" class="btn waves-effect waves-light blue" type="submit">
                        <i class="material-icons right">search</i> Buscar
                    </button>
                </div>
            </div>
            <br>
        </div>
        <div class="title-container">
            <h5><b><span>Sistema de recomendación películas basado en redes semánticas</span></b></h5>
        </div>
        <br>

        <!-- Barra de progreso -->
        <div class="col s12 m12">
            <div id="progress" class="progress" style="display: none;">
                <div class="indeterminate"></div>
            </div>
        </div>

        <div class="row">
            <div class="col s4">
                <span id="contarPeliculas"></span>
                <br>
                <span id="mostrarTextoGenero"></span>

                <ul id="tabs tabs-fixed-width tab-demo z-depth-1" class="tabs">
                    <li class="tab col s4 blue-text"><a href="#tabGrafos" class="active">Grafos</a></li>
                    <li class="tab col s4 blue-text"><a href="#tabGenero">Por género</a></li>
                    <li class="tab col s4 blue-text"><a href="#tabVectorial">Vectorial</a></li>
                </ul>

                <div class="card tabla" id="tabGrafos" style="height: 500px;">
                    <table class="highlight">
                        <thead>
                            <tr>
                                <th>MovieId</th>
                                <th>Película</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody id="moviesTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="card tabla" id="tabGenero" style="height: 500px;">
                    <table class="highlight">
                        <thead>
                            <tr>
                                <th>MovieId</th>
                                <th>Película</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody id="moviesPorGeneroTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="card tabla" id="tabVectorial" style="height: 500px;">
                    <table class="highlight">
                        <thead>
                            <tr>
                                <th>MovieId</th>
                                <th>Película</th>
                                <th>Similaridad</th>
                            </tr>
                        </thead>
                        <tbody id="vectorialTableBody">
                        </tbody>
                    </table>
                    <div id="data"></div>
                </div>
            </div>
            <div class="col s4">
                Red del peliculas vistas por el Usuario (Rating=5)
                <div id="button-container-user">
                    <button id="maximize-button-user" class="btn waves-effect waves-light blue"
                        onclick="toggleFullScreenUser()">Maximizar Red del Usuario</button>
                </div>
                <div class="card" id="cyUser">
                </div>
            </div>
            <div class="col s4">
                Ruta del Usuario a Pelicula recomendada
                <div id="button-container-peli">
                    <button id="maximize-button-peli" class="btn waves-effect waves-light blue"
                        onclick="toggleFullScreenPeli()">Maximizar Ruta Usuario-Película</button>
                </div>
                <div class="card" id="cyPeli">
                </div>
                <h6>UNI - MIA-103 (A) 2024 - Grupo 3</h6>
            </div>
        </div>

    </div>

    <script>

        let isFullScreenUser = false;
        let isFullScreenPeli = false;

        function toggleFullScreenUser() {
            const cyElement = document.getElementById('cyUser');

            if (!isFullScreenUser) {
                // Maximizar pantalla completa
                cyElement.classList.add('fullscreenU');
                document.getElementById('maximize-button-user').textContent = 'Minimizar Red del Usuario';
            } else {
                // Minimizar pantalla completa
                cyElement.classList.remove('fullscreenU');
                document.getElementById('maximize-button-user').textContent = 'Maximizar Red del Usuario';
            }

            isFullScreenUser = !isFullScreenUser;
        }

        function toggleFullScreenPeli() {
            const cyElement = document.getElementById('cyPeli');

            if (!isFullScreenPeli) {
                // Maximizar pantalla completa
                cyElement.classList.add('fullscreenP');
                document.getElementById('maximize-button-peli').textContent = 'Minimizar Ruta Usuario-Película';
            } else {
                // Minimizar pantalla completa
                cyElement.classList.remove('fullscreenP');
                document.getElementById('maximize-button-peli').textContent = 'Maximizar Ruta Usuario-Película';
            }

            isFullScreenPeli = !isFullScreenPeli;
        }

        // Configuración de la conexión a Neo4j
        const URL_DB = `neo4j+s://b7d43e72.databases.neo4j.io`;
        const USER_DB = `neo4j`;
        const PASS_DB = `yZdzfrdwzmDB0FyeWnQ7RBwMPFhDGtlLaoB8jAsyz18`;
        // Crea una instancia del driver, especificando la URL de tu base de datos y las credenciales
        const driver = neo4j.driver(
            URL_DB, // URL de la base de datos
            neo4j.auth.basic(USER_DB, PASS_DB) // Usuario y contraseña
        );

        async function consultarDataPorCriterioFiltro(genero, paramTitulo, paramUsuario, queryNoPeliUser) {
            const session = driver.session();
            try {

                progress.style.display = "block"; // Mostrar barra de progreso

                const result = await session.run(paramTitulo); // Ejecutar la consulta con el parametro establecido
                const resultDataNoPeliUser = await session.run(queryNoPeliUser); // Ejecutar la consulta con el parametro establecido

                const nodeNoPeliUser = []; // Nodo para la data de peliculas que el usuario no ha visto
                const nodes = [];          // Nodo para la data de peliculas
                const edges = [];          // Relaciones entre los nodos usuarios, peliculas y géneros
                const nodeSet = new Set();

                // Tabla película y rating
                const moviesTableBody = document.getElementById("moviesTableBody");

                // Convertir los registros obtenidos a nodos pero usarlo como una lista para la tabla
                resultDataNoPeliUser.records.forEach(record => {
                    nodeNoPeliUser.push({
                        data: {
                            movieId: record._fields[0],
                            label: record._fields[1],
                            rating: record._fields[2]
                        }
                    });
                });


                result.records.forEach((record) => {
                    const path = record.get("p");
                    // console.log('resulta: ', path);

                    path.segments.forEach((segment) => {
                        const startNode = segment.start;
                        const endNode = segment.end;
                        const relationship = segment.relationship;

                        if (!nodeSet.has(startNode.identity.toString())) {
                            nodes.push({
                                data: {
                                    id: startNode.identity.toString(),
                                    label: startNode.labels.includes("Peliculas") ? startNode.properties.title
                                        : startNode.labels.includes("Genero") ? startNode.properties.Genero
                                            : startNode.properties.Usuario,
                                    type: startNode.labels[0],
                                },
                            });
                            nodeSet.add(startNode.identity.toString());
                        }

                        if (!nodeSet.has(endNode.identity.toString())) {
                            nodes.push({
                                data: {
                                    id: endNode.identity.toString(),
                                    label: endNode.labels.includes("Peliculas") ? endNode.properties.title
                                        : endNode.labels.includes("Genero") ? endNode.properties.Genero
                                            : endNode.properties.Usuario,
                                    type: endNode.labels[0],
                                },
                            });
                            nodeSet.add(endNode.identity.toString());
                        }

                        edges.push({
                            data: {
                                id: relationship.identity.toString(),
                                source: startNode.identity.toString(),
                                target: endNode.identity.toString(),
                                label: relationship.type,
                            },
                        });
                    });
                });

                // console.log('resulta: ', nodes);
                const elements = [...nodes, ...edges];

                // Limpiar la tabla
                moviesTableBody.innerHTML = "";

                // Actualizar el label con el número de películas que no ha visto el usuario
                contarPeliculas.textContent = `${nodeNoPeliUser.length === 0 ? "" : `${nodeNoPeliUser.length} película(s) recomendadas del género: ${genero}`} `;

                // Creación de la tabla de peliculas que no ha visto el usuario con los ratings y sus botones
                nodeNoPeliUser.forEach((movie) => {
                    const row = document.createElement("tr");
                    const movieIdCell = document.createElement("td");
                    const titleCell = document.createElement("td");
                    const ratingCell = document.createElement("td");
                    const actionCell = document.createElement("td");
                    const button = document.createElement("button");
                    const icon = document.createElement("i");
                    movieIdCell.textContent = movie.data.movieId.low || "N/A";
                    titleCell.textContent = movie.data.label || "N/A";
                    ratingCell.textContent = movie.data.rating.toFixed(4) || "N/A";
                    button.classList.add(
                        "btn",
                        "waves-effect",
                        "waves-light",
                        "blue",
                        "tooltipped"
                    );
                    button.setAttribute("data-tooltip", "Mostrar en grafos");
                    icon.classList.add("material-icons");
                    icon.textContent = "hub"; // Ícono de visibilidad

                    button.appendChild(icon);
                    button.addEventListener("click", async () => {
                        progress.style.display = "block";
                        const titulo = movie.data.label;
                        const titulolimpio = titulo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

                        // Query que se mostrará la pelicula del usuario como parametros y se visualizará en grafos para el frame derecho
                        const query = `
                            match p=shortestpath((:Usuario {id_usuario: ${paramUsuario}})-[*]-(:Peliculas {title: '${titulolimpio}'})) return p
                        `;

                        // ejecutar la consulta
                        await consultarDataPorTituloPeli(query);
                    });

                    actionCell.appendChild(button);
                    row.appendChild(movieIdCell);
                    row.appendChild(titleCell);
                    row.appendChild(ratingCell);
                    row.appendChild(actionCell);
                    moviesTableBody.appendChild(row);
                });

                // Inicializar tooltips de Materialize
                const tooltips = document.querySelectorAll(".tooltipped");
                M.Tooltip.init(tooltips);

                dibujarGrafosU(elements)

                // consultarTablaPostgresql(genero);

            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los datos de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                // Ocultar barra de progreso
                progress.style.display = "none";
            } finally {
                // Ocultar barra de progreso
                progress.style.display = "none";
                await session.close();
            }
        }

        // Mostrar el mensaje flotante dependiendo de la acciones
        function mostrarMensajeFlotante(message, actionColor, tipo) {
            var toastHTML = `<span>${message}</span><button class="btn-flat toast-action ${actionColor}">${tipo}</button>`;
            M.toast({ html: toastHTML, classes: 'toast-custom', displayLength: 6000 }); // Duración de 6 segundos
        }

        // Metodo para mostrar la tabla sin registros de peliculas
        function inicializarMensajeSinRegistroTabla() {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 3;
            cell.textContent = "No hay registros";
            cell.style.textAlign = "center";
            row.appendChild(cell);
            moviesTableBody.appendChild(row);

            const row2 = document.createElement("tr");
            const cell2 = document.createElement("td");
            cell2.colSpan = 3;
            cell2.textContent = "No hay registros";
            cell2.style.textAlign = "center";
            row2.appendChild(cell2);
            moviesPorGeneroTableBody.appendChild(row2);

            const row3 = document.createElement("tr");
            const cell3 = document.createElement("td");
            cell3.colSpan = 3;
            cell3.textContent = "No hay registros";
            cell3.style.textAlign = "center";
            row3.appendChild(cell3);
            vectorialTableBody.appendChild(row3);
        }

        function random(number) {
            const result = Math.floor(Math.random() * number);

            return result;
        }

        async function consultarDataPorGenero(queryGenero) {

            const session = driver.session();
            try {
                progress.style.display = "block"; // Mostrar barra de progreso

                const resultGenero = await session.run(queryGenero);
                let dataGenero = "";

                // Convertir los registros obtenidos a nodos pero usarlo como una lista para la tabla
                resultGenero.records.forEach(record => {
                    // console.log('resultGenero: ', record._fields[0]);
                    dataGenero = record._fields[0]
                });
                return dataGenero;
            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los datos de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                progress.style.display = "none";
            } finally {
                progress.style.display = "none";
                await session.close();
            }
        }


        // Consultar la pelicula desde la tabla
        async function consultarDataPorTituloPeli(query) {
            const session = driver.session();
            const progress = document.getElementById("progress");

            try {

                const result = await session.run(query);
                const nodes = [];   // Nodo para la data de peliculas
                const edges = [];   // Relaciones entre los nodos usuarios, peliculas y géneros
                const nodeSet = new Set();

                result.records.forEach((record) => {
                    const path = record.get("p");

                    path.segments.forEach((segment) => {
                        const startNode = segment.start;
                        const endNode = segment.end;
                        const relationship = segment.relationship;

                        if (!nodeSet.has(startNode.identity.toString())) {
                            nodes.push({
                                data: {
                                    id: startNode.identity.toString(),
                                    label: startNode.labels.includes("Peliculas") ? startNode.properties.title
                                        : startNode.labels.includes("Genero") ? startNode.properties.Genero
                                            : startNode.properties.Usuario,
                                    type: startNode.labels[0],
                                },
                            });
                            nodeSet.add(startNode.identity.toString());
                        }

                        if (!nodeSet.has(endNode.identity.toString())) {
                            nodes.push({
                                data: {
                                    id: endNode.identity.toString(),
                                    label: endNode.labels.includes("Peliculas") ? endNode.properties.title
                                        : endNode.labels.includes("Genero") ? endNode.properties.Genero
                                            : endNode.properties.Usuario,
                                    type: endNode.labels[0],
                                },
                            });
                            nodeSet.add(endNode.identity.toString());
                        }

                        edges.push({
                            data: {
                                id: relationship.identity.toString(),
                                source: startNode.identity.toString(),
                                target: endNode.identity.toString(),
                                label: relationship.type,
                            },
                        });
                    });
                });

                const elements = [...nodes, ...edges];

                dibujarGrafosP(elements)
            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los datos de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                progress.style.display = "none";
            } finally {
                progress.style.display = "none";
                await session.close();
            }
        }

        // Inicialización de Materialize CSS
        document.addEventListener('DOMContentLoaded', function () {

            // Inicializar configuración de los tabs
            var elems = document.querySelectorAll('select');
            M.FormSelect.init(elems);

            var elemsTabs = document.querySelectorAll('.tabs');
            var instances = M.Tabs.init(elemsTabs, {
                swipeable: true
            });

            // Activar tabs de "Grafos" de manera inicial
            M.Tabs.getInstance(elemsTabs[0]).select('tabGrafos');

            let paramUsuario = "";
            let paramGenero = "";
            let paramTextBusq = "";

            // Obtener los elementos select y los botones
            const userSelect = document.getElementById('user-select');
            const genreSelect = document.getElementById('genero-select');
            const userButton = document.getElementById('searchButton-user');
            const genreButton = document.getElementById('searchButton-genero');
            const paramTextBusqueda = document.getElementById('textInputBusqueda')
            const textBusquedaButton = document.getElementById('searchButton-textBusqueda');

            // Event listener para el select de usuario
            userSelect.addEventListener('change', function () {
                paramUsuario = userSelect.value.trim();
                console.log("Usuario seleccionado:", paramUsuario);
            });

            // Event listener para el botón de usuario
            userButton.addEventListener('click', function () {
                // Activar tabs de "Grafos"
                M.Tabs.getInstance(elemsTabs[0]).select('tabGrafos');
                paramUsuario = userSelect.value;

                M.FormSelect.init(paramUsuario);
                // Query de las peliculas y ratings que el usario no ha visto que se visualizará en una lista
                let queryGenero = `
                            
                            MATCH (n:Peliculas)-[:Genero]-(g:Genero)
                            where EXISTS {MATCH (n)-[t:Rating  where t.rating=5]-(:Usuario {id_usuario: ${paramUsuario}})}
                            RETURN g.Genero,count(g) as cant  order by cant desc limit 1
                    `;

                consultarDataPorGenero(queryGenero).then(genero => {
                    let queryNoPeliUser = `
                            MATCH (n:Peliculas)-[:Genero]-(g:Genero)
                            where  NOT EXISTS {MATCH (n)-[t:Rating]-(:Usuario {id_usuario: ${paramUsuario}})}
                            and g.Genero="${genero}"
                            MATCH ()-[r:Rating]-(n)
                            with  n.movieId as movieId,n.title as title,avg(r.rating) as avg_r,count(r) as cantidad
                            where cantidad>3
                            RETURN movieId,title,avg_r ,  cantidad   order by avg_r desc limit 20
                        `;

                    // Query para mostrar las peliculas con sus generos del usuario como parametro que se visualizará en grafos
                    let query = `
                            MATCH p=(u:Usuario {id_usuario: ${paramUsuario}})-[t:Rating where t.rating = 5]-(m:Peliculas)-[:Genero]-(:Genero) RETURN p
                        `;

                    // Limpiar grafos de visualización
                    let elements = []
                    dibujarGrafosP(elements);
                    consultarDataPorCriterioFiltro(genero, query, paramUsuario, queryNoPeliUser);
                });
            });

            // Event listener para el botón de género
            genreButton.addEventListener('click', function () {
                // Activar tabs de "Por género"
                M.Tabs.getInstance(elemsTabs[0]).select('tabGenero');
                paramGenero = genreSelect.value;
                console.log("Género seleccionado:", paramGenero);
                console.log("Usuario ya seleccionado:", paramUsuario);

                let queryNoPeliUser = `
                            MATCH (n:Peliculas)-[:Genero]-(g:Genero)
                            where  NOT EXISTS {MATCH (n)-[t:Rating]-(:Usuario {id_usuario: ${paramUsuario}})}
                            and g.Genero="${paramGenero}"
                            MATCH ()-[r:Rating]-(n)
                            with  n.movieId as movieId,n.title as title,avg(r.rating) as avg_r,count(r) as cantidad
                            where cantidad>3
                            RETURN movieId,title,avg_r ,  cantidad   order by avg_r desc limit 20
                    `;

                // Limpiar grafos de visualización
                let elements = []
                dibujarGrafosP(elements);

                // Llamar a la función con ambos parámetros
                consultarDataPorGeneroyUsuarioPersistido(paramUsuario, queryNoPeliUser);
            });

            // Event listener para el botón de texto búsqeuda
            textBusquedaButton.addEventListener('click', function () {
                // Activar tabs de "Vectorial"
                M.Tabs.getInstance(elemsTabs[0]).select('tabVectorial');
                paramTextBusq = paramTextBusqueda.value;
                console.log("Texto de búsqueda por: ", paramTextBusq);

                // Limpiar grafos de visualización
                let elements = []
                dibujarGrafosP(elements);
                consultarTablaPostgresql(paramTextBusq, paramUsuario)
            })
        });

        async function consultarDataPorGeneroyUsuarioPersistido(paramUsuario, queryNoPeliUser) {

            const session = driver.session();
            const progress = document.getElementById("progress");

            try {

                progress.style.display = "block"; // Mostrar barra de progreso

                const resultDataNoPeliUser = await session.run(queryNoPeliUser); // Ejecutar la consulta con el parametro establecido

                const nodeNoPeliUser = []; // Nodo para la data de peliculas que el usuario no ha visto

                // Tabla película y rating que se seleccionara por genero
                const moviesPorGeneroTableBody = document.getElementById("moviesPorGeneroTableBody");

                // Convertir los registros obtenidos a nodos pero usarlo como una lista para la tabla
                resultDataNoPeliUser.records.forEach(record => {
                    nodeNoPeliUser.push({
                        data: {
                            movieId: record._fields[0],
                            label: record._fields[1],
                            rating: record._fields[2]
                        }
                    });
                });

                // Limpiar la tabla
                moviesPorGeneroTableBody.innerHTML = "";

                // Creación de la tabla de peliculas que no ha visto el usuario con los ratings y sus botones
                nodeNoPeliUser.forEach((movie) => {
                    const row = document.createElement("tr");
                    const movieIdCell = document.createElement("td");
                    const titleCell = document.createElement("td");
                    const ratingCell = document.createElement("td");
                    const actionCell = document.createElement("td");
                    const button = document.createElement("button");
                    const icon = document.createElement("i");
                    movieIdCell.textContent = movie.data.movieId.low || "N/A";
                    titleCell.textContent = movie.data.label || "N/A";
                    ratingCell.textContent = movie.data.rating.toFixed(4) || "N/A";
                    button.classList.add(
                        "btn",
                        "waves-effect",
                        "waves-light",
                        "blue",
                        "tooltipped"
                    );
                    button.setAttribute("data-tooltip", "Mostrar en grafos");
                    icon.classList.add("material-icons");
                    icon.textContent = "hub"; // Ícono de visibilidad

                    button.appendChild(icon);
                    button.addEventListener("click", async () => {
                        progress.style.display = "block";
                        const titulo = movie.data.label;
                        const titulolimpio = titulo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

                        // Query que se mostrará la pelicula del usuario como parametros y se visualizará en grafos para el frame derecho
                        const query = `
                            match p=shortestpath((:Usuario {id_usuario: ${paramUsuario}})-[*]-(:Peliculas {title: '${titulolimpio}'})) return p
                        `;
                        console.log('query=> ', query);
                        // ejecutar la consulta
                        await consultarDataPorTituloPeli(query);
                    });

                    actionCell.appendChild(button);
                    row.appendChild(movieIdCell);
                    row.appendChild(titleCell);
                    row.appendChild(ratingCell);
                    row.appendChild(actionCell);
                    moviesPorGeneroTableBody.appendChild(row);
                });

                // Inicializar tooltips de Materialize
                const tooltips = document.querySelectorAll(".tooltipped");
                M.Tooltip.init(tooltips);

            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los datos de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                // Ocultar barra de progreso
                progress.style.display = "none";
            } finally {
                // Ocultar barra de progreso
                progress.style.display = "none";
                await session.close();
            }

        }

        function consultarTablaPostgresql(keyword, paramUsuario) {

            progress.style.display = "block"; // Mostrar barra de progreso
            const query = `SELECT * FROM public.sa_busqueda_semantica_vec WHERE LOWER(keyword) LIKE '%${keyword.toLowerCase()}%' LIMIT 20`;

            fetch(`https://grafosbusqueda-edcb8df8ba74.herokuapp.com/data`, { // para apuntar a Heroku
                // fetch('http://localhost:3000/data', { // para apuntar a local
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ queryAux: query })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.details); });
                    }
                    progress.style.display = "none"; // Ocultar barra de progreso
                    return response.json();
                })
                .then(data => {
                    console.log('data vectorial: ', data);
                    document.getElementById('vectorialTableBody').innerHTML = "";
                    const dataDiv = document.getElementById('data');

                    data.forEach(row => {
                        let newRow = document.getElementById('vectorialTableBody').insertRow(-1);
                        newRow.innerHTML = `
                        <td>${row.movieid}</td>
                        <td>${row.tittle}</td>
                        <td>${row.similaridad}</td>
                        <td>
                            <button class="btn waves-effect waves-light tooltipped blue" data-tooltip="Mostrar en grafos">
                                <i class="material-icons">hub</i>
                            </button>
                        </td>
                    `;

                        // Añadir event listener al botón
                        let button = newRow.querySelector('button');
                        button.addEventListener('click', () => {
                            progress.style.display = "block";
                            console.log('paramUsuario', paramUsuario);
                            
                            if(paramUsuario === ""){
                                // Mostrar mensaje de alerta
                                let message = (`No se encuentra el usuario seleccionado`);
                                let actionColor = `yelow-text`;
                                let tipo = `Aviso`;
                                // Ocultar barra de progreso
                                progress.style.display = "none";
                                return mostrarMensajeFlotante(message, actionColor, tipo);
                            }
                            const query = `match p=shortestpath((:Usuario {id_usuario: ${paramUsuario}})-[*]-(:Peliculas {title: '${row.tittle.trim()}'})) return p`;
                            console.log(query);
                            consultarDataPorTituloPeli(query);
                        });

                        progress.style.display = "none"; // Ocultar barra de progreso
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        async function dibujarGrafosU(elements) {
            const cy = cytoscape({
                container: document.getElementById("cyUser"),
                elements: elements,
                style: [
                    {
                        selector: "node",
                        style: {
                            "background-color": function (ele) {
                                if (ele.data("type") === "Usuario") return "#F0A30A"; // Color amarillo
                                if (ele.data("type") === "Peliculas") return "#60A917"; // Color verde
                                if (ele.data("type") === "Genero") return "#1BA1E2"; // Color celeste
                                return "red"; // Default color for other types
                            },
                            label: "data(label)",
                            shape: "ellipse", // Mantener la forma de círculo
                            "text-wrap": "wrap", // Envolver texto
                            "text-max-width": "80px", // Máximo ancho del texto dentro del nodo
                            "text-valign": "center",
                            "text-halign": "center",
                            color: "#fff",
                            "font-size": "12px",
                            height: "80px", // Altura fija del nodo
                            width: "80px", // Ancho fijo del nodo
                        },
                    },
                    {
                        selector: "edge",
                        style: {
                            width: 10,
                            "target-arrow-shape": "triangle", // Forma de la flecha
                            'curve-style': 'bezier', // Curva Bezier para las aristas
                            label: "data(label)",
                            "font-size": "10px",
                            "text-rotation": "autorotate",
                            "text-margin-y": -10,
                            "line-color": "#FAE6B4",
                            "target-arrow-color": "#FAE6B4",
                        },
                    },
                ],
                layout: {
                    name: "cose",
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                },
            });
        }


        async function dibujarGrafosP(elements) {
            const cy = cytoscape({
                container: document.getElementById("cyPeli"),
                elements: elements,
                style: [
                    {
                        selector: "node",
                        style: {
                            "background-color": function (ele) {
                                if (ele.data("type") === "Usuario") return "#F0A30A"; // Color amarillo
                                if (ele.data("type") === "Peliculas") return "#60A917"; // Color verde
                                if (ele.data("type") === "Genero") return "#1BA1E2"; // Color celeste
                                return "#CCCCCC"; // Default color for other types
                            },
                            label: "data(label)",
                            shape: "ellipse", // Mantener la forma de círculo
                            "text-wrap": "wrap", // Envolver texto
                            "text-max-width": "80px", // Máximo ancho del texto dentro del nodo
                            "text-valign": "center",
                            "text-halign": "center",
                            color: "#fff",
                            "font-size": "12px",
                            height: "80px", // Altura fija del nodo
                            width: "80px", // Ancho fijo del nodo
                        },
                    },
                    {
                        selector: "edge",
                        style: {
                            width: 10,
                            "target-arrow-shape": "triangle", // Forma de la flecha
                            'curve-style': 'bezier', // Curva Bezier para las aristas
                            label: "data(label)",
                            "font-size": "10px",
                            "text-rotation": "autorotate",
                            "text-margin-y": -10,
                            "line-color": "#FAE6B4",
                            "target-arrow-color": "#FAE6B4",
                        },
                    },
                ],
                layout: {
                    name: "cose",
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                },
            });
        }

        async function inicializarListaUsuarios() {
            const session = driver.session();
            try {
                // Consulta a Neo4j para obtener todos los usuarios
                const result = await session.run('MATCH (u:Usuario) RETURN u');
                const userSelect = document.getElementById('user-select');

                result.records.forEach(record => {
                    const userNode = record.get('u');
                    const option = document.createElement('option');
                    option.value = userNode.properties.id_usuario;
                    option.text = userNode.properties.Usuario;
                    userSelect.appendChild(option);
                });

                // Re-inicializar el componente select de Materialize
                M.FormSelect.init(userSelect);
            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los usuarios de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                progress.style.display = "none";
            } finally {
                await session.close();
            }
        }

        async function inicializarListaGeneros() {
            const session = driver.session();
            try {
                // Consulta a Neo4j para obtener todos los géneros
                const result = await session.run('MATCH (g:Genero) RETURN g');
                const generoSelect = document.getElementById('genero-select');

                result.records.forEach(record => {
                    const userNode = record.get('g');
                    const option = document.createElement('option');
                    option.value = userNode.properties.Genero;
                    option.text = userNode.properties.Genero;
                    generoSelect.appendChild(option);
                });

                // Re-inicializar el componente select de Materialize
                M.FormSelect.init(generoSelect);
            } catch (error) {
                // Mostrar mensaje de alerta
                let message = (`Error al obtener los géneros de Neo4j: `, error);
                let actionColor = `red-text`;
                let tipo = `Error`;
                mostrarMensajeFlotante(message, actionColor, tipo);
                progress.style.display = "none";
            } finally {
                await session.close();
            }
        }

        // Llamar a la función con una consulta inicial al cargar la página
        window.onload = () => {
            inicializarMensajeSinRegistroTabla()
            inicializarListaUsuarios();
            inicializarListaGeneros();
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

</body>

</html>